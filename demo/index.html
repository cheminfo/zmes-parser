<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>zmes-parser browser demo</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 900px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      #output {
        white-space: pre-wrap;
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 13px;
        max-height: 80vh;
        overflow: auto;
        display: none;
      }
      #error {
        color: #c00;
        white-space: pre-wrap;
        display: none;
      }
      #status {
        color: #666;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <h1>zmes-parser browser demo</h1>
    <p>Select a <code>.zmes</code> file to parse it in the browser.</p>
    <input type="file" id="file-input" accept=".zmes" />
    <div id="status"></div>
    <div id="error"></div>
    <pre id="output"></pre>

    <script type="module">
      import {
        parse,
        toMeasurementXY,
      } from '../dist/zmes-parser.esm.js';

      const fileInput = document.getElementById('file-input');
      const output = document.getElementById('output');
      const error = document.getElementById('error');
      const status = document.getElementById('status');

      fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        output.style.display = 'none';
        error.style.display = 'none';
        status.textContent = `Parsing ${file.name}â€¦`;

        try {
          const arrayBuffer = await file.arrayBuffer();
          const zmesFile = await parse(arrayBuffer);
          const measurements = toMeasurementXY(zmesFile);

          const result = {
            schemaVersion: zmesFile.schemaVersion,
            metadata: zmesFile.metadata,
            numberOfRecords: zmesFile.records.length,
            measurements: measurements.map((m) => ({
              id: m.id,
              title: m.title,
              dataType: m.dataType,
              meta: m.meta,
              settings: m.settings,
              variables: Object.fromEntries(
                Object.entries(m.variables).map(([key, v]) => [
                  key,
                  {
                    label: v.label,
                    units: v.units,
                    symbol: v.symbol,
                    isDependent: v.isDependent,
                    length: v.data.length,
                    first5: Array.from(v.data.slice(0, 5)),
                    last5: Array.from(v.data.slice(-5)),
                  },
                ]),
              ),
            })),
          };

          status.textContent = `Parsed ${file.name} successfully.`;
          output.textContent = JSON.stringify(result, null, 2);
          output.style.display = 'block';
        } catch (err) {
          status.textContent = '';
          error.textContent = `Error: ${err.message}\n\n${err.stack}`;
          error.style.display = 'block';
        }
      });
    </script>
  </body>
</html>
